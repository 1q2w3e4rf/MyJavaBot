//–ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
package org.example;
import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import java.io.IOException;
//–î–µ–ª–∞–µ–º –∫–ª–∞—Å—Å
public class MyTelegramBot extends TelegramLongPollingBot {

    private final String BOT_USERNAME = "@test_rekikol_bot";//username –±–æ—Ç–∞
    private final String BOT_TOKEN = "6804594259:AAEu03onfNbMDd4HmS9-QvuWcOqxLfQl--I";//–¢–æ–∫–µ–Ω –±–æ—Ç–∞

    @Override
    public String getBotUsername() {
        return BOT_USERNAME;
    }

    @Override
    public String getBotToken() {
        return BOT_TOKEN;
    }

    private String[] getExchangeRate(String currencyPair) {// –ü–∞—Ä—Å–∏–Ω–≥ –∫—É—Ä—Å–∞
        String url = "https://ru.investing.com/currencies/" + currencyPair.toLowerCase();
        String[] result = new String[2];
        try {
            Document doc = Jsoup.connect(url).get();
            Elements priceElements = doc.select("div[data-test=instrument-price-last]");
            Elements percentChangeElements = doc.select("span[data-test=instrument-price-change-percent]");

            result[0] = priceElements.size() > 0 ? priceElements.get(0).text() : "–ö—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
            result[1] = percentChangeElements.size() > 0 ? percentChangeElements.get(0).text() : "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
            return result;
        } catch (IOException e) {
            result[0] = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: " + e.getMessage();
            result[1] = "–û—à–∏–±–∫–∞";
            return result;
        }
    }

    @Override
    public void onUpdateReceived(Update update) {// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        if (update.hasMessage() && update.getMessage().hasText()) {
            String messageText = update.getMessage().getText().toLowerCase();
            long chatId = update.getMessage().getChatId();

            if (messageText.equals("/usd") || messageText.equals("–¥–æ–ª–ª–∞—Ä")) {
                String[] rate = getExchangeRate("usd-rub");
                sendMessage(chatId, "–ö—É—Ä—Å USD/RUB: " + rate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + rate[1]);
            } else if (messageText.equals("/eur") || messageText.equals("–µ–≤—Ä–æ")) {
                String[] rate = getExchangeRate("eur-rub");
                sendMessage(chatId, "–ö—É—Ä—Å EUR/RUB: " + rate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + rate[1]);
            } else if (messageText.equals("/start")) {
                sendMessage(chatId, "üëã–ü—Ä–∏–≤–µ—Ç —è –±–æ—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫—É—Ä—Å–∞ üí≤ –∏ üí∂");
            } else if (messageText.equals("/help") || messageText.equals("–ø–æ–º–æ—â—å")) {
                sendMessage(chatId, "(‚óè'‚ó°'‚óè)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/usd - –∫—É—Ä—Å USD/RUB‚úåÔ∏è\n/eur - –∫—É—Ä—Å EUR/RUB‚úåÔ∏è");
            } else {
                sendMessage(chatId, "ü§∑‚Äç‚ôÄÔ∏è–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ü§∑‚Äç‚ôÇÔ∏è");
            }
        }
    }

    private void sendMessage(long chatId, String text) {// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        SendMessage message = new SendMessage();
        message.setChatId(chatId);
        message.setText(text);
        try {
            execute(message);
        } catch (TelegramApiException e) {
            e.printStackTrace();
        }
    }
}
