package org.example;

import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.select.Elements;

import java.io.IOException;
import java.util.HashMap;
import java.util.Timer;
import java.util.TimerTask;

public class MyTelegramBot extends TelegramLongPollingBot {
    private final String BOT_USERNAME = "";
    private final String BOT_TOKEN = "";

    private HashMap<Long, TrackingData> trackingData = new HashMap<>(); // –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

    @Override
    public String getBotUsername() {
        return BOT_USERNAME;
    }

    @Override
    public String getBotToken() {
        return BOT_TOKEN;
    }

    private String[] getExchangeRate(String currencyPair) {
        // URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∫—É—Ä—Å–æ–º –≤–∞–ª—é—Ç—ã
        String url = "https://ru.investing.com/currencies/" + currencyPair.toLowerCase();
        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: –∫—É—Ä—Å –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
        String[] result = new String[2];
        try {
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏ –ø–∞—Ä—Å–∏–º HTML —Å –ø–æ–º–æ—â—å—é Jsoup
            Document doc = Jsoup.connect(url).get();
            // –í—ã–±–∏—Ä–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å –ø–æ–º–æ—â—å—é CSS-—Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
            Elements priceElements = doc.select("div[data-test=instrument-price-last]");
            Elements percentChangeElements = doc.select("span[data-test=instrument-price-change-percent]");

            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫—É—Ä—Å –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
            result[0] = priceElements.size() > 0 ? priceElements.get(0).text() : "–ö—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
            result[1] = percentChangeElements.size() > 0 ? percentChangeElements.get(0).text() : "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            return result;
        } catch (IOException e) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ç–∏)
            result[0] = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: " + e.getMessage();
            result[1] = "–û—à–∏–±–∫–∞";
            return result;
        }
    }


    @Override
    public void onUpdateReceived(Update update) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç
        if (update.hasMessage() && update.getMessage().hasText()) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
            String messageText = update.getMessage().getText().toLowerCase();
            // –ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–∞
            long chatId = update.getMessage().getChatId();

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥:
            //–ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∏–∑ –∫–æ–º–∞–Ω–¥.  –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –æ—à–∏–±–∫—É –≤ –ª–æ–≥–∏–∫–µ –Ω–∏–∂–µ.
            if (messageText.equals("/usd") || messageText.equals("–¥–æ–ª–ª–∞—Ä")) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º || (–ò–õ–ò), –∞ –Ω–µ && (–ò)
                String[] rate = getExchangeRate("usd-rub");
                sendMessage(chatId, "–ö—É—Ä—Å USD/RUB: " + rate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + rate[1] + "\nüòá");
            } else if (messageText.equals("/kzt") || messageText.equals("—Ç–µ–Ω–≥–µ")) {
                String[] rate = getExchangeRate("kzt-rub");
                sendMessage(chatId, "–ö—É—Ä—Å KZT/RUB: " + rate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + rate[1] + "\nüòá");
            } else if (messageText.equals("/jpy") || messageText.equals("–∏–µ–Ω–∞")) {
                String[] rate = getExchangeRate("jpy-rub");
                sendMessage(chatId, "–ö—É—Ä—Å JPY/RUB: " + rate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + rate[1] + "\nüòá");
            } else if (messageText.equals("/eur") || messageText.equals("–µ–≤—Ä–æ")) {
                String[] rate = getExchangeRate("eur-rub");
                sendMessage(chatId, "–ö—É—Ä—Å EUR/RUB: " + rate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + rate[1] + "\nüòá");
            } else if (messageText.equals("/cny") || messageText.equals("—é–∞–Ω—å")) {
                String[] rate = getExchangeRate("cny-rub");
                sendMessage(chatId, "–ö—É—Ä—Å CNY/RUB: " + rate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + rate[1] + "\nüòá");
            } else if (messageText.equals("/start")) { // –ö–æ–º–∞–Ω–¥–∞ /start
                sendMessage(chatId, "üëã–ü—Ä–∏–≤–µ—Ç —è –±–æ—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫—É—Ä—Å–∞ üí≤ –∏ üí∂");
            } else if (messageText.equals("/help") || messageText.equals("–ø–æ–º–æ—â—å")) { // –ö–æ–º–∞–Ω–¥–∞ /help –∏–ª–∏ "–ø–æ–º–æ—â—å"
                sendMessage(chatId, "(‚óè'‚ó°'‚óè)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/usd - –∫—É—Ä—Å USD/RUB‚úåÔ∏è\n/eur - –∫—É—Ä—Å EUR/RUB‚úåÔ∏è\n/cny - –∫—É—Ä—Å CNY/RUB‚úåÔ∏è\n/kzt - –∫—É—Ä—Å KZT/RUB‚úåÔ∏è\n/jpy - –∫—É—Ä—Å JPY/RUB‚úåÔ∏è\n/track - –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫—É—Ä—Å (USD/RUB)\n/stop - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ");
            } else if (messageText.equals("/track")) { // –ö–æ–º–∞–Ω–¥–∞ /track - –∑–∞–ø—É—Å–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                startTracking(chatId);
            } else if (messageText.equals("/stop")) { // –ö–æ–º–∞–Ω–¥–∞ /stop - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                stopTracking(chatId);
            } else { // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∏–∑ –∫–æ–º–∞–Ω–¥
                String[] rate = getExchangeRate(messageText);
                if (rate != null && rate.length >= 2) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–ª–æ–≤ "–æ—à–∏–±–∫–∞" –∏–ª–∏ "404" –≤ —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞
                    if (rate[0].toLowerCase().contains("–æ—à–∏–±–∫–∞") || rate[0].toLowerCase().contains("404") || rate[1].toLowerCase().contains("–æ—à–∏–±–∫–∞") || rate[1].toLowerCase().contains("404")) {
                        sendMessage(chatId, "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ—Ç—É –∫—É—Ä—Å–∞ –¥–ª—è " + messageText);
                    } else {
                        sendMessage(chatId, "–ö—É—Ä—Å " + messageText + ": " + rate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + rate[1] + "\nüòá");
                    }
                }
            }
        }
    }

    private void sendMessage(long chatId, String text) {
        SendMessage message = new SendMessage();
        message.setChatId(chatId);
        message.setText(text);
        try {
            execute(message);
        } catch (TelegramApiException e) {
            e.printStackTrace();
        }
    }

    private void startTracking(long chatId) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ —É–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
        if (trackingData.containsKey(chatId)) {
            // –ï—Å–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —ç—Ç–æ–º
            sendMessage(chatId, "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ!");
            return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
        }
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ HashMap
        trackingData.put(chatId, new TrackingData());
        // –°–æ–∑–¥–∞–µ–º —Ç–∞–π–º–µ—Ä
        Timer timer = new Timer();
        // –ü–ª–∞–Ω–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Å –ø–æ–º–æ—â—å—é TimerTask
        timer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                checkAndSendUpdate(chatId);
            }
        }, 0, 60000); // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ (0) –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 6000 –º—Å (6 —Å–µ–∫—É–Ω–¥)
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
        sendMessage(chatId, "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞ USD/RUB –∏ EUR/RUB –∑–∞–ø—É—â–µ–Ω–æ!");
    }

    private void stopTracking(long chatId) {
        // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞ –∏–∑ HashMap
        trackingData.remove(chatId);
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
        sendMessage(chatId, "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!");
    }



    private void checkAndSendUpdate(long chatId) {
        // –ü–æ–ª—É—á–∞–µ–º –∫—É—Ä—Å—ã USD/RUB –∏ EUR/RUB
        String[] usdRate = getExchangeRate("usd-rub");
        String[] eurRate = getExchangeRate("eur-rub");
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
        TrackingData data = trackingData.get(chatId);

        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
        if (data == null) return;

        // –°—Ç—Ä–æ–∫–∞ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        String message = "";
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ –∫—É—Ä—Å USD/RUB
        if (!usdRate[0].equals(data.lastUsdRate)) {
            // –ï—Å–ª–∏ –∫—É—Ä—Å –∏–∑–º–µ–Ω–∏–ª—Å—è, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
            message += "–ö—É—Ä—Å USD/RUB –∏–∑–º–µ–Ω–∏–ª—Å—è:\n–°—Ç–∞—Ä—ã–π –∫—É—Ä—Å: " + data.lastUsdRate + "\n–ù–æ–≤—ã–π –∫—É—Ä—Å: " + usdRate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + usdRate[1] + "\n\n";
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫—É—Ä—Å–∞
            data.lastUsdRate = usdRate[0];
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ –∫—É—Ä—Å EUR/RUB
        if (!eurRate[0].equals(data.lastEurRate)) {
            // –ï—Å–ª–∏ –∫—É—Ä—Å –∏–∑–º–µ–Ω–∏–ª—Å—è, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
            message += "–ö—É—Ä—Å EUR/RUB –∏–∑–º–µ–Ω–∏–ª—Å—è:\n–°—Ç–∞—Ä—ã–π –∫—É—Ä—Å: " + data.lastEurRate + "\n–ù–æ–≤—ã–π –∫—É—Ä—Å: " + eurRate[0] + "\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ: " + eurRate[1] + "\n";
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫—É—Ä—Å–∞
            data.lastEurRate = eurRate[0];
        }

        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ (—Ç.–µ. –∫—É—Ä—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å), –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (!message.isEmpty()) {
            sendMessage(chatId, message);
        }
    }



    private class TrackingData {
        String lastUsdRate = "";
        String lastEurRate = "";
    }
}
